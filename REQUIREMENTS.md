# ぬりえもん デスクトップアプリ版 要件定義書

## プロジェクト概要

### 背景
- 既存のWebアプリケーション「ぬりえもん」（oekaki-screen）をデスクトップアプリケーションとして再構築
- 元プロジェクト: `/Users/nga/oekaki-screen` (Webアプリ版)
- 新プロジェクト: `/Users/nga/nuriemon` (デスクトップ版)

ぬりえもんは子どもに楽しんでもらう為のツール。
自分の描いた絵や塗り絵が画面に反映して動くのが特徴。

### 目的
1. **完全オフライン化**: インターネット接続不要で全機能を利用可能に
2. **軽量化**: アプリケーションサイズを最小限に（目標: 30MB以下）
3. **モダン化**: 1年以上前のコードベースを最新技術で刷新
4. **配布容易性**: 一般ユーザーが簡単にインストール・利用できる形に
5. **プロダクション品質**: 商用製品として販売可能な品質を確保

## 開発品質基準

### コード品質要件
1. **プロダクションレディ**: 「とりあえず動く」コードは不可。商用製品として恥ずかしくない品質を維持
2. **アーキテクチャ優先**: 機能追加前に適切な設計を行い、技術的負債を作らない
3. **パフォーマンス重視**: ポーリングなど非効率な実装は避け、イベント駆動など適切なパターンを使用
4. **保守性**: 将来の機能追加・修正を考慮した拡張性のある設計
5. **一貫性**: コーディング規約、命名規則、ディレクトリ構造の統一

### AI開発者への指示
1. **実装前の設計**: 新機能実装前に必ずアーキテクチャ設計を提示し、承認を得ること
2. **改善提案の義務**: 実装完了後、より良い実装方法があれば必ず提案すること
3. **問題の早期報告**: 設計上の問題や技術的負債を発見したら即座に報告すること
4. **ベストプラクティス**: Tauriや各技術スタックのベストプラクティスに従うこと

### 品質チェックリスト
- [ ] コードは商用製品として適切な品質か
- [ ] パフォーマンスは最適化されているか
- [ ] エラーハンドリングは適切か
- [ ] セキュリティは考慮されているか
- [ ] 将来の拡張性は確保されているか
- [ ] テストは書かれているか（将来実装予定）

## 技術選定

### 採用技術スタック
- **フレームワーク**: Tauri (Rust + WebView)
- **フロントエンド**: React 18+ with TypeScript
- **ビルドツール**: Vite
- **スタイリング**: CSS Modules + Sass (Tailwind CSSは不採用)
- **画像処理**: Python (rembg/U2Net) - sidecarとしてバンドル
- **ローカルDB**: SQLite
- **状態管理**: Zustand または Jotai

## 機能要件

### コア機能（既存機能の移植）
1. **画像アップロード・処理**
   - ローカルファイルシステムからの画像選択
   - AI背景除去機能（Python sidecar）
   - 処理済み画像のローカル保存

2. **アニメーション機能**
   - 画像の動き設定（移動、速度、サイズ、タイプ）
   - Canvas描画によるアニメーション表示
   - 音響効果（ローカル音源）

3. **ギャラリー機能**
   - 処理済み画像の一覧表示
   - 画像の管理（削除、編集）



### 新規要件
1. **自動アップデート機能**
   - アプリケーションの自動更新通知・実行

## 非機能要件

### パフォーマンス
- 起動時間: 3秒以内
- 画像処理: 1枚あたり5秒以内（背景除去）
- メモリ使用量: 500MB以下

### セキュリティ
- ローカルデータの暗号化（オプション）
- 外部通信なし（完全オフライン）

### 配布
- Windows: MSIインストーラー（コード署名推奨）
- macOS: DMGファイル（公証対応）
- インストールサイズ: 30MB以下目標

## システムアーキテクチャ

### アーキテクチャ設計原則
1. **ワークスペースベース**: 各フォルダが独立したワークスペースとして機能
2. **マルチウィンドウ対応**: アニメーション機能など、独立したウィンドウで動作する機能を考慮
3. **イベント駆動**: ウィンドウ間通信はTauriのイベントシステムを使用
4. **データ一貫性**: SQLiteを中心としたデータ管理、ワークスペース単位での独立性
5. **責務の分離**: UI、ビジネスロジック、データアクセスの明確な分離

### ディレクトリ構造
```
nuriemon/
├── src-tauri/              # Tauriバックエンド (Rust)
│   ├── src/
│   │   ├── lib.rs          # メインライブラリ
│   │   ├── main.rs         # エントリーポイント
│   │   ├── db.rs           # SQLite操作
│   │   ├── events.rs       # イベントエミッター（ウィンドウ間通信）
│   │   └── workspace.rs    # ワークスペース管理
│   └── tauri.conf.json     # Tauri設定
├── src/                    # Reactフロントエンド
│   ├── App.tsx            # メインアプリケーション
│   ├── windows/           # ウィンドウ別エントリーポイント
│   │   └── AnimationWindow.tsx
│   ├── components/        # UIコンポーネント
│   │   ├── WorkspaceSelector.tsx  # ワークスペース選択
│   │   └── SettingsPage.tsx       # 初期設定画面
│   ├── services/          # ビジネスロジック
│   │   ├── workspaceManager.ts    # ワークスペース管理
│   │   └── database.ts            # DB操作
│   ├── hooks/             # カスタムフック
│   │   └── useWorkspace.ts        # ワークスペースフック
│   ├── events/            # イベントリスナー管理
│   └── styles/            # Sass/CSSモジュール
├── python-sidecar/        # Python画像処理
│   ├── main.py           # エントリーポイント
│   ├── requirements.txt  # 依存関係
│   └── dist/             # PyInstallerビルド出力
└── vite.config.ts        # Vite設定
```

### ワークスペースアーキテクチャ
```
ワークスペース（フォルダ）
├── .nuriemon/              # ワークスペース専用データ
│   ├── nuriemon.db         # SQLiteデータベース
│   └── settings.json       # ワークスペース設定
├── images/                 # 画像ファイル
│   ├── originals/         # オリジナル画像
│   ├── processed/         # 処理済み画像
│   └── backgrounds/       # 背景画像
└── audio/                 # 音声ファイル
    ├── bgm-*.mp3         # BGM
    └── soundEffect-*.mp3  # 効果音
```

### ウィンドウ間通信アーキテクチャ
```
メインウィンドウ                    アニメーションウィンドウ
     ↓                                    ↑
データ変更 → Rust (events.rs) → イベント配信
     ↓                                    ↑
ワークスペースDB ←────────────────────────→
```

## データ移行計画

### 既存システムからの変更
| 既存 (Web版) | 新規 (デスクトップ版) |
|------------|------------------|
| Firebase Auth | ローカル認証 (SQLite) |
| Firestore | SQLite |
| Cloud Storage | ローカルファイルシステム |
| SendGrid | システム通知 |
| オンライン共有 | ファイルエクスポート |

### データ保存場所

#### ワークスペースベースの保存
- **ワークスペース単位**: 各フォルダが独立した作業環境として機能
- **ポータブル性**: フォルダごと移動・コピーが可能
- **データの独立性**: ワークスペース間でデータは共有されない

#### グローバル設定の保存場所
- Windows: `%APPDATA%/nuriemon/global_settings.json`
- macOS: `~/Library/Application Support/nuriemon/global_settings.json`
- Linux: `~/.config/nuriemon/global_settings.json`

### ワークスペース管理
- 起動時に最後に使用したワークスペースを自動的に開く
- ワークスペース切り替え時は動的にDB接続を切り替え
- 各ワークスペースは`.nuriemon/`ディレクトリに設定とDBを保存

## 開発ロードマップ

### Phase 1: 基盤構築（完了）
1. ✅ Tauriプロジェクトのセットアップ
2. ✅ 基本的なReact + TypeScript環境構築
3. ✅ SassとCSS Modulesの設定
4. ✅ Gitリポジトリの設定

### Phase 2: 基盤機能実装（完了）
1. ✅ **ファイル選択ダイアログの実装**
   - Tauriのファイルダイアログ APIを使用
   - 画像ファイル（.png, .jpg, .jpeg, .gif）のみ選択可能に

2. ✅ **ローカルファイルシステムAPIの設定**
   - 画像の保存・読み込み権限設定
   - アプリデータディレクトリの設定

3. ✅ **画像アップロード機能の実装**
   - 選択した画像のプレビュー表示
   - Canvasでの画像表示
   - 画像のローカル保存

### Phase 3: コア機能実装（完了）
4. ✅ **Python画像処理サービスの統合**
   - 背景除去機能の移植（rembg/U2Net使用）
   - Rust経由でPython実行
   - JSON形式でのプロセス間通信

5. ✅ **ギャラリー機能の実装**
   - 処理済み画像の一覧表示
   - サムネイル生成
   - 画像の削除・管理機能
   - メタデータ管理（JSON形式）

6. ✅ **保存先選択機能**
   - アプリデータ、ピクチャ、ダウンロード、ドキュメント、カスタムフォルダ選択
   - カスタムディレクトリへの保存（Rust側カスタムコマンド実装）
   - 設定の永続化

### Phase 4: 応用機能実装（完了）
1. ✅ **ローカルDB (SQLite)の設定**
   - 画像メタデータの移行（JSONからSQLiteへ）
   - ユーザー設定の保存
   - 処理履歴の管理
   - より高度なクエリ機能
   - 動き設定の保存機能

2. ✅ **アニメーション機能の移植**
   - 既存の動き設定（移動、速度、サイズ、タイプ）を移植
   - Canvasアニメーションの実装
   - プレビュー機能
   - 背景、BGM、効果音の設定機能

### Phase 4.5: 機能改善と修正（完了）
1. ✅ **マルチウィンドウアーキテクチャの実装**
   - Tauriイベントシステムの統合
   - ウィンドウ間のリアルタイム通信
   - イベント駆動への部分的な移行

2. ✅ **効果音再生の修正**
   - 初回画像追加時の効果音再生問題を解決
   - 音声プールの管理改善

3. ✅ **削除機能の改善**
   - ギャラリーからの削除ボタン修正
   - アニメーション画面の背景表示修正
   - Tauriネイティブダイアログに統一

### Phase 4.6: UI/UX改善（完了）
1. ✅ **アップロードページの機能分離**
   - 初期設定ページの作成
   - 高頻度機能（画像アップロード）の分離

2. ✅ **設定管理の統一化**
   - AppSettingsServiceへの完全移行
   - フォルダ設定の永続化修正
   - 背景の即時アップロード機能復元
   - エラーハンドリング強化

### Phase 4.7: 自動取り込み機能（未実装）
1. **フォルダ監視による自動画像取り込み**
   - 指定フォルダの監視機能（Tauriのnotifyクレート使用）
   - 新規画像の自動検出と背景除去処理
   - スキャナー連携を想定した自動ワークフロー
   - ファイルシステムイベントによる効率的な実装

2. **自動アニメーション設定**
   - 動きのプリセットパターン（ふわふわ、ぴょんぴょん、くるくる等）
   - 画面密度を考慮したスマート配置
   - 年齢設定に応じた動きの調整
   - ランダム性を持たせた自然な動き

### Phase 5: ユーザー管理・配布準備（未実装）
1. **ユーザー管理機能**
   - マルチユーザー対応
   - プロファイル切り替え
   - 個別設定の保存

2. **配布用ビルド設定**
   - Windows用MSIインストーラー作成
   - macOS用DMGファイル作成
   - コード署名の設定

3. **自動アップデート機能**
   - アップデートチェック機能
   - 差分アップデートの実装
   - 更新通知UI

4. **子ども操作機能（スキャン時QR紐付け方式）**
   - 内蔵Webサーバーによるローカルネットワーク通信
   - 画像アップロード時に個別QRコード表示（30秒程度）
   - その場でスマホとの紐付けを完了
   - WebSocketを使用したリアルタイム操作
   - QR未読み取り時は自動アニメーションにフォールバック
   - アニメーション画面にはQRコードを表示しない（観覧体験優先）
   - 年齢に応じた操作インターフェース（シンプル/アドバンス）

## AI開発者への最終注意
このプロジェクトは商用製品として販売予定です。
思考は英語でも構わないが、コミュニケーションは必ず日本語で。

「とりあえず動く」コードを書いた場合、それは技術的負債として後で必ず問題になります。
最初から正しく実装することで、長期的な開発効率と製品品質を保ちましょう。

## AIの役割
・claude = 実際にコードの追加や修正開発を行う役割
・gemini = コードはいじらず、claudeが行った修正プロセスとその結果について、チェッカーとして見解を述べる役割