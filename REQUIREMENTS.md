# ぬりえもん デスクトップアプリ版 要件定義書

## プロジェクト概要

### 背景
- 既存のWebアプリケーション「ぬりえもん」（oekaki-screen）をデスクトップアプリケーションとして再構築
- 元プロジェクト: `/Users/nga/oekaki-screen` (Webアプリ版)
- 新プロジェクト: `/Users/nga/nuriemon` (デスクトップ版)

### 目的
1. **完全オフライン化**: インターネット接続不要で全機能を利用可能に
2. **軽量化**: アプリケーションサイズを最小限に（目標: 30MB以下）
3. **モダン化**: 1年以上前のコードベースを最新技術で刷新
4. **配布容易性**: 一般ユーザーが簡単にインストール・利用できる形に

## 技術選定

### 採用技術スタック
- **フレームワーク**: Tauri (Rust + WebView)
- **フロントエンド**: React 18+ with TypeScript
- **ビルドツール**: Vite
- **スタイリング**: CSS Modules + Sass (Tailwind CSSは不採用)
- **画像処理**: Python (rembg/U2Net) - sidecarとしてバンドル
- **ローカルDB**: SQLite
- **状態管理**: Zustand または Jotai

### 不採用とした選択肢
- Electron: アプリサイズが大きい（150MB以上）
- React Native Desktop: 既存資産の活用が困難
- Flutter Desktop: React資産を活かせない

## 機能要件

### コア機能（既存機能の移植）
1. **画像アップロード・処理**
   - ローカルファイルシステムからの画像選択
   - AI背景除去機能（Python sidecar）
   - 処理済み画像のローカル保存

2. **アニメーション機能**
   - 画像の動き設定（移動、速度、サイズ、タイプ）
   - Canvas描画によるアニメーション表示
   - 音響効果（ローカル音源）

3. **ギャラリー機能**
   - 処理済み画像の一覧表示
   - 画像の管理（削除、編集）

4. **共有機能（オフライン版）**
   - ローカルファイルとしてエクスポート
   - 他のぬりえもんユーザーとのファイル共有

### 新規要件
1. **ローカルユーザー管理**
   - マルチユーザー対応（家族での共用を想定）
   - プロファイル切り替え機能

2. **自動アップデート機能**
   - アプリケーションの自動更新通知・実行

## 非機能要件

### パフォーマンス
- 起動時間: 3秒以内
- 画像処理: 1枚あたり5秒以内（背景除去）
- メモリ使用量: 500MB以下

### セキュリティ
- ローカルデータの暗号化（オプション）
- 外部通信なし（完全オフライン）

### 配布
- Windows: MSIインストーラー（コード署名推奨）
- macOS: DMGファイル（公証対応）
- インストールサイズ: 30MB以下目標

## システムアーキテクチャ

```
nuriemon/
├── src-tauri/              # Tauriバックエンド (Rust)
│   ├── src/
│   │   ├── main.rs         # メインプロセス
│   │   ├── commands.rs     # フロントエンドAPIコマンド
│   │   ├── db.rs           # SQLite操作
│   │   └── file_system.rs  # ファイル管理
│   └── tauri.conf.json     # Tauri設定
├── src/                    # Reactフロントエンド
│   ├── App.tsx            # メインアプリケーション
│   ├── components/        # UIコンポーネント
│   ├── services/          # ビジネスロジック
│   ├── hooks/             # カスタムフック
│   └── styles/            # Sass/CSSモジュール
├── python-sidecar/        # Python画像処理
│   ├── main.py           # エントリーポイント
│   ├── requirements.txt  # 依存関係
│   └── dist/             # PyInstallerビルド出力
└── vite.config.ts        # Vite設定
```

## データ移行計画

### 既存システムからの変更
| 既存 (Web版) | 新規 (デスクトップ版) |
|------------|------------------|
| Firebase Auth | ローカル認証 (SQLite) |
| Firestore | SQLite |
| Cloud Storage | ローカルファイルシステム |
| SendGrid | システム通知 |
| オンライン共有 | ファイルエクスポート |

### データ保存場所
### デフォルト保存場所
- Windows: `%APPDATA%/nuriemon/`
- macOS: `~/Library/Application Support/nuriemon/`
- Linux: `~/.config/nuriemon/`

### カスタム保存場所対応
- ユーザーが任意のディレクトリを選択可能
- 選択可能なプリセット: アプリデータ、ピクチャ、ダウンロード、ドキュメント
- カスタムディレクトリ選択時はRust側のカスタムコマンドで処理

## 開発ロードマップ

### Phase 1: 基盤構築（完了）
1. ✅ Tauriプロジェクトのセットアップ
2. ✅ 基本的なReact + TypeScript環境構築
3. ✅ SassとCSS Modulesの設定
4. ✅ Gitリポジトリの設定

### Phase 2: 基盤機能実装（完了）
1. ✅ **ファイル選択ダイアログの実装**
   - Tauriのファイルダイアログ APIを使用
   - 画像ファイル（.png, .jpg, .jpeg, .gif）のみ選択可能に

2. ✅ **ローカルファイルシステムAPIの設定**
   - 画像の保存・読み込み権限設定
   - アプリデータディレクトリの設定

3. ✅ **画像アップロード機能の実装**
   - 選択した画像のプレビュー表示
   - Canvasでの画像表示
   - 画像のローカル保存

### Phase 3: コア機能実装（完了）
4. ✅ **Python画像処理サービスの統合**
   - 背景除去機能の移植（rembg/U2Net使用）
   - Rust経由でPython実行
   - JSON形式でのプロセス間通信

5. ✅ **ギャラリー機能の実装**
   - 処理済み画像の一覧表示
   - サムネイル生成
   - 画像の削除・管理機能
   - メタデータ管理（JSON形式）

6. ✅ **保存先選択機能**
   - アプリデータ、ピクチャ、ダウンロード、ドキュメント、カスタムフォルダ選択
   - カスタムディレクトリへの保存（Rust側カスタムコマンド実装）
   - 設定の永続化

### Phase 4: 応用機能実装（完了）
7. ✅ **ローカルDB (SQLite)の設定**
   - 画像メタデータの移行（JSONからSQLiteへ）
   - ユーザー設定の保存
   - 処理履歴の管理
   - より高度なクエリ機能
   - 動き設定の保存機能

8. ✅ **アニメーション機能の移植**
   - 既存の動き設定（移動、速度、サイズ、タイプ）を移植
   - Canvasアニメーションの実装
   - プレビュー機能
   - 背景、BGM、効果音の設定機能

9. **ユーザー管理機能**
   - マルチユーザー対応
   - プロファイル切り替え
   - 個別設定の保存

### Phase 5: 配布準備（3-4週間）
10. **配布用ビルド設定**
    - Windows用MSIインストーラー作成
    - macOS用DMGファイル作成
    - コード署名の設定

11. **自動アップデート機能**
    - アップデートチェック機能
    - 差分アップデートの実装
    - 更新通知UI

### Phase 5: ユーザー管理・配布準備（現在）
9. **ユーザー管理機能**
   - マルチユーザー対応
   - プロファイル切り替え
   - 個別設定の保存

10. **配布用ビルド設定**
    - Windows用MSIインストーラー作成
    - macOS用DMGファイル作成
    - コード署名の設定

11. **自動アップデート機能**
    - アップデートチェック機能
    - 差分アップデートの実装
    - 更新通知UI

### 開発優先順位（完了済みタスクを反映）
1. ✅ **完了**: ファイル選択 → 画像表示 → Python統合 → ローカル保存 → ギャラリー → 保存先選択 → DB設定 → アニメーション
2. **中優先**: ユーザー管理
3. **低優先**: 配布設定 → 自動アップデート

## 制約事項

1. **Tailwind CSS不使用**: 明示的な要望により採用しない
2. **完全オフライン**: インターネット接続を前提としない設計
3. **既存資産の活用**: 可能な限り既存のReactコンポーネントを再利用

## 参考情報

- 元プロジェクトリポジトリ: `/Users/nga/oekaki-screen`
- 主要な既存コンポーネント:
  - UploadPage.js: 画像アップロード機能
  - ViewPage.js: アニメーション表示
  - ImageGallery.js: ギャラリー機能

## 実装済み機能詳細

### ファイルシステム統合
- Tauri v2のファイルシステムプラグイン使用
- 動的スコープ管理（ダイアログ選択時の自動権限付与）
- カスタムRustコマンド実装（ensure_directory, write_file_absolute, read_file_absolute, file_exists_absolute）

### UI/UXの実装
- マテリアルデザイン風のモダンなUI
- 設定モーダルによる保存先変更
- リアルタイムギャラリー更新
- 画像処理中の進捗表示

### Python統合の詳細
- rembg（U2Net）による高精度背景除去
- JSON形式でのプロセス間通信
- Base64エンコーディングによる画像データ転送
- エラーハンドリングとタイムアウト処理

## 技術的な決定事項

### Rustバージョン管理
- rustup経由でのRust管理（Homebrew版から移行）
- 最新安定版の使用（1.88.0以降）

### TypeScript/React設定
- strict modeの有効化
- CSS ModulesとSassの併用
- Viteによる高速ビルド

## 最近の更新

### 2025-07-18: 削除機能の改善
- Tauriネイティブダイアログの統合
- カスタムディレクトリからのファイル削除対応
- 2重ダイアログ問題の解決

### 2025-07-17: Phase 4完了
- SQLiteデータベースの実装
- アニメーション機能の完全移植
- 背景、BGM、効果音機能の実装
- 動き設定の永続化

## 今後の開発予定

1. **ユーザー管理機能**
   - 家族での共用を想定したマルチユーザー対応
   - プロファイル別の設定・データ管理

2. **配布準備**
   - インストーラーの作成
   - コード署名の設定
   - 自動アップデート機能

## 更新履歴
- 2025-07-14: 初版作成、開発ロードマップ詳細化
- 2025-07-14: Phase 2, 3完了、保存先選択機能実装、実装済み機能詳細追加
- 2025-07-17: Phase 4完了、SQLiteとアニメーション機能実装
- 2025-07-18: 削除機能の改善、Tauriダイアログ統合

思考は英語でも何でもいいけど、やりとりは日本語でお願い。